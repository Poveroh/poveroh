worker_processes auto;
events { worker_connections 1024; }

http {
    server_names_hash_bucket_size 128;

    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # Use Docker's embedded DNS resolver and lazy DNS resolution at request time.
    # This prevents nginx from failing at startup if some containers aren't yet registered
    # in Docker's DNS. Requests will resolve names when requested.
    resolver 127.0.0.11 valid=30s ipv6=off;
    resolver_timeout 5s;

    # Server block for app
    server {
        listen 80;
        server_name app.poveroh.local;

        location / {
            # Resolve backend at request time (avoid startup DNS failures)
            set $backend "app:3000";
            proxy_pass http://$backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_connect_timeout 2s;
            proxy_read_timeout 10s;
            proxy_send_timeout 10s;
        }
    }

    # Server block for API
    server {
        listen 80;
        server_name api.poveroh.local;

        location / {
            set $backend "api:3001";
            proxy_pass http://$backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_connect_timeout 2s;
            proxy_read_timeout 10s;
            proxy_send_timeout 10s;
        }
    }

    # Server block for DB
    # NOTE: Postgres is a TCP service. Proxying it over HTTP is not supported by this HTTP
    # nginx configuration. Keep this server block only for lightweight checks or HTTP
    # wrappers. For actual DB TCP forwarding use nginx stream module or access DB from
    # other containers directly by service name (recommended).
    server {
        listen 80;
        server_name db.poveroh.local;

        location / {
            # Try to contact an HTTP health endpoint if your DB wrapper exposes one.
            # Otherwise this will return an error for non-HTTP traffic.
            set $backend "db:5432";
            proxy_pass http://$backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 1s;
            proxy_read_timeout 5s;
        }
    }

    # Server block for Studio
    server {
        listen 80;
        server_name studio.poveroh.local;

        location / {
            set $backend "studio:5555";
            proxy_pass http://$backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 2s;
            proxy_read_timeout 30s;
        }
    }

    # Server block for Redis
    # Redis is a TCP service; HTTP proxying won't work for real Redis traffic.
    server {
        listen 80;
        server_name redis.poveroh.local;

        location / {
            # This only helps if you have an HTTP wrapper; otherwise access Redis from
            # other containers by name (redis:6379) or configure stream/TCP proxying.
            set $backend "redis:6379";
            proxy_pass http://$backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 1s;
        }
    }

    # Server block for CDN
    server {
        listen 80;
        server_name cdn.poveroh.local;

        location / {
            root /usr/share/cdn-data;
            autoindex on;
        }
    }
}

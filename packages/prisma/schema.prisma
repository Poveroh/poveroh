datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

generator client {
    provider = "prisma-client-js"
}

// ===========================================================================
// USER & AUTHENTICATION
// ===========================================================================
model User {
    id                String             @id @default(uuid())
    name              String
    surname           String
    email             String             @unique
    emailVerified     Boolean            @default(false)
    onBoardingStep    Int                @default(2)
    onBoardingAt      DateTime?
    image             String?
    snapshotFrequency SnapshotFrequency  @default(MONTHLY)
    // User Configuration Settings
    preferredCurrency Currency           @default(EUR)
    preferredLanguage Language           @default(EN)
    dateFormat        DateFormat         @default(DD_MM_YYYY)
    country           String             @default("italy")
    timezone          Timezone           @default(ETC_UTC)
    //Other
    createdAt         DateTime           @default(now())
    updatedAt         DateTime           @updatedAt
    transactions      Transaction[]
    transfers         Transfer[]
    subscriptions     Subscription[]
    categories        Category[]
    financialAccounts FinancialAccount[]
    imports           Import[]
    sessions          Session[]
    accounts          Account[]
    verifications     Verification[]
    assets            Asset[]
    snapshots         Snapshot[]

    @@index([surname])
    @@index([createdAt])
    @@index([email])
}

model Session {
    id        String   @id @default(uuid())
    token     String   @unique
    userId    String
    expiresAt DateTime
    ipAddress String?
    userAgent String?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([token])
}

model Account {
    id                    String    @id @default(uuid())
    accountId             String    @unique
    providerId            String
    userId                String
    accessToken           String?
    refreshToken          String?
    idToken               String?
    accessTokenExpiresAt  DateTime?
    refreshTokenExpiresAt DateTime?
    scope                 String?
    password              String?
    createdAt             DateTime  @default(now())
    updatedAt             DateTime  @updatedAt
    user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
}

model Verification {
    id         String   @id @default(uuid())
    identifier String
    value      String
    expiresAt  DateTime
    userId     String?
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt
    user       User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([identifier, value])
    @@index([identifier])
    @@index([expiresAt])
    @@index([userId])
}

// ===========================================================================
// FINANCIAL ACCOUNTS
// ===========================================================================
model FinancialAccount {
    id               String                   @id @default(uuid())
    userId           String
    title            String
    description      String
    balance          Decimal                  @default(0) @db.Decimal(20, 2)
    type             FinancialAccountType     @default(BANK_ACCOUNT)
    logoIcon         String?
    createdAt        DateTime                 @default(now())
    updatedAt        DateTime                 @updatedAt
    subscriptions    Subscription[]
    amounts          Amount[]
    user             User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
    imports          Import[]
    snapshotBalances SnapshotAccountBalance[]

    @@index([userId])
    @@map("FinancialAccounts")
}

// ===========================================================================
// ASSET SYSTEM
// ===========================================================================
model Asset {
    id             String               @id @default(uuid())
    userId         String
    title          String
    description    String?
    type           AssetType
    currency       Currency             @default(EUR)
    createdAt      DateTime             @default(now())
    updatedAt      DateTime             @updatedAt
    user           User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
    marketable     MarketableAsset?
    realEstate     RealEstateAsset?
    collectible    CollectibleAsset?
    privateDeal    PrivateDealAsset?
    insurance      InsuranceAsset?
    transactions   AssetTransaction[]
    snapshotValues SnapshotAssetValue[]

    @@index([userId])
    @@index([userId, type])
}

model MarketableAsset {
    id      String  @id @default(uuid())
    assetId String  @unique
    symbol  String?
    isin    String?
    asset   Asset   @relation(fields: [assetId], references: [id], onDelete: Cascade)
}

model RealEstateAsset {
    id            String    @id @default(uuid())
    assetId       String    @unique
    address       String?
    purchasePrice Decimal?  @db.Decimal(20, 2)
    purchaseDate  DateTime?
    currentValue  Decimal?  @db.Decimal(20, 2)
    asset         Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)
}

model CollectibleAsset {
    id              String    @id @default(uuid())
    assetId         String    @unique
    acquisitionCost Decimal?  @db.Decimal(20, 2)
    acquisitionDate DateTime?
    appraisalValue  Decimal?  @db.Decimal(20, 2)
    appraisalDate   DateTime?
    asset           Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)
}

model PrivateDealAsset {
    id              String    @id @default(uuid())
    assetId         String    @unique
    committedAmount Decimal?  @db.Decimal(20, 2)
    calledAmount    Decimal?  @db.Decimal(20, 2)
    latestNav       Decimal?  @db.Decimal(20, 2)
    navDate         DateTime?
    asset           Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)
}

model InsuranceAsset {
    id             String   @id @default(uuid())
    assetId        String   @unique
    policyNumber   String?
    premiumPaid    Decimal? @db.Decimal(20, 2)
    surrenderValue Decimal? @db.Decimal(20, 2)
    asset          Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
}

model AssetTransaction {
    id             String   @id @default(uuid())
    assetId        String
    date           DateTime
    quantityChange Decimal  @db.Decimal(20, 10)
    unitPrice      Decimal? @db.Decimal(20, 8)
    totalAmount    Decimal? @db.Decimal(20, 2)
    fees           Decimal? @db.Decimal(10, 2)
    note           String?
    asset          Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

    @@index([assetId])
    @@index([assetId, date])
}

// ===========================================================================
// SNAPSHOT (historical wealth)
// ===========================================================================
model Snapshot {
    id               String                   @id @default(uuid())
    userId           String
    snapshotDate     DateTime                 @db.Timestamptz
    note             String?
    totalCash        Decimal                  @db.Decimal(20, 2)
    totalInvestments Decimal                  @db.Decimal(20, 2)
    totalNetWorth    Decimal                  @db.Decimal(20, 2)
    user             User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
    accountBalances  SnapshotAccountBalance[]
    assetValues      SnapshotAssetValue[]

    @@unique([userId, snapshotDate])
    @@index([userId, snapshotDate(sort: Desc)])
}

model SnapshotAccountBalance {
    id         String           @id @default(uuid())
    snapshotId String
    accountId  String
    balance    Decimal          @db.Decimal(20, 2)
    snapshot   Snapshot         @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
    account    FinancialAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

    @@unique([snapshotId, accountId])
}

model SnapshotAssetValue {
    id         String   @id @default(uuid())
    snapshotId String
    assetId    String
    quantity   Decimal? @db.Decimal(20, 10)
    unitPrice  Decimal? @db.Decimal(20, 8)
    totalValue Decimal  @db.Decimal(20, 2)
    snapshot   Snapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
    asset      Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

    @@unique([snapshotId, assetId])
}

// ===========================================================================
// IMPORT & TRANSACTIONS
// ===========================================================================
model Import {
    id                 String            @id @default(uuid())
    userId             String
    title              String
    financialAccountId String
    status             TransactionStatus @default(IMPORT_PENDING)
    createdAt          DateTime          @default(now())
    user               User              @relation(fields: [userId], references: [id], onDelete: Cascade)
    financialAccount   FinancialAccount  @relation(fields: [financialAccountId], references: [id], onDelete: Cascade)
    transactions       Transaction[]
    files              ImportFile[]

    @@index([userId])
    @@index([status])
}

model ImportFile {
    id        String   @id @default(uuid())
    importId  String
    filename  String
    filetype  FileType
    path      String
    createdAt DateTime @default(now())
    import    Import   @relation(fields: [importId], references: [id], onDelete: Cascade)

    @@index([importId])
}

model Transaction {
    id            String             @id @default(uuid())
    userId        String
    date          DateTime
    title         String
    note          String?
    icon          String?
    categoryId    String?
    subcategoryId String?
    importId      String?
    action        TransactionAction  @default(EXPENSES)
    status        TransactionStatus  @default(APPROVED)
    ignore        Boolean            @default(false)
    createdAt     DateTime           @default(now())
    updatedAt     DateTime           @updatedAt
    media         TransactionMedia[]
    amounts       Amount[]

    transferId   String?
    transferHash String? @db.VarChar(64)

    user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
    category     Category?    @relation(fields: [categoryId], references: [id], onDelete: SetNull)
    subcategory  Subcategory? @relation(fields: [subcategoryId], references: [id], onDelete: SetNull)
    import       Import?      @relation(fields: [importId], references: [id], onDelete: SetNull)
    fromTransfer Transfer?    @relation("FromLeg")
    toTransfer   Transfer?    @relation("ToLeg")

    @@index([userId])
    @@index([date])
    @@index([userId, date])
    @@index([transferId])
    @@index([transferHash])
    @@index([importId])
    @@index([categoryId])
    @@index([subcategoryId])
}

model Transfer {
    id                String   @id @default(uuid())
    userId            String
    transferDate      DateTime
    note              String?
    fromTransactionId String?  @unique
    toTransactionId   String?  @unique
    createdAt         DateTime @default(now())
    updatedAt         DateTime @updatedAt

    user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
    fromTransaction Transaction? @relation("FromLeg", fields: [fromTransactionId], references: [id], onDelete: SetNull)
    toTransaction   Transaction? @relation("ToLeg", fields: [toTransactionId], references: [id], onDelete: SetNull)

    @@index([userId])
    @@index([transferDate])
    @@index([fromTransactionId])
    @@index([toTransactionId])
    @@index([userId, transferDate])
}

model TransactionMedia {
    id            String      @id @default(uuid())
    transactionId String
    filename      String
    filetype      String
    path          String
    createdAt     DateTime    @default(now())
    transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

    @@index([transactionId])
}

model Amount {
    id                 String            @id @default(uuid())
    transactionId      String
    amount             Decimal           @db.Decimal(20, 2)
    currency           Currency
    action             TransactionAction @default(EXPENSES)
    financialAccountId String
    importReference    String?
    createdAt          DateTime          @default(now())
    financialAccount   FinancialAccount  @relation(fields: [financialAccountId], references: [id], onDelete: Cascade)
    transaction        Transaction       @relation(fields: [transactionId], references: [id], onDelete: Cascade)

    @@index([transactionId])
    @@index([financialAccountId])
    @@index([action])
}

// ===========================================================================
// SUBSCRIPTIONS
// ===========================================================================
model Subscription {
    id                 String           @id @default(uuid())
    userId             String
    title              String
    description        String?
    amount             Decimal          @db.Decimal(20, 2)
    currency           Currency
    appearanceMode     AppearanceMode
    appearanceLogoIcon String
    firstPayment       DateTime
    cycleNumber        String
    cyclePeriod        String
    rememberPeriod     RememberPeriod
    financialAccountId String
    isEnabled          Boolean
    createdAt          DateTime         @default(now())
    user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)
    financialAccount   FinancialAccount @relation(fields: [financialAccountId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([financialAccountId])
    @@index([isEnabled])
}

// ===========================================================================
// CATEGORIES & SUBCATEGORIES
// ===========================================================================
model Category {
    id            String            @id @default(uuid())
    userId        String
    title         String
    description   String?
    for           TransactionAction
    logoIcon      String
    color         String            @default("#8B5CF6")
    createdAt     DateTime          @default(now())
    transactions  Transaction[]
    subcategories Subcategory[]
    user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([for])
}

model Subcategory {
    id           String        @id @default(uuid())
    categoryId   String
    title        String
    description  String?
    logoIcon     String
    createdAt    DateTime      @default(now())
    transactions Transaction[]
    category     Category      @relation(fields: [categoryId], references: [id], onDelete: Cascade)

    @@index([categoryId])
}

// ===========================================================================
// ENUMS
// ===========================================================================
enum Timezone {
    AFRICA_ALGIERS
    AFRICA_CAIRO
    AFRICA_CASABLANCA
    AFRICA_HARARE
    AFRICA_JOHANNESBURG
    AFRICA_MONROVIA
    AFRICA_NAIROBI
    AFRICA_WEST_CENTRAL
    AMERICA_ARGENTINA_BUENOS_AIRES
    AMERICA_BOGOTA
    AMERICA_CARACAS
    AMERICA_CHICAGO
    AMERICA_CHIHUAHUA
    AMERICA_DENVER
    AMERICA_GUATEMALA
    AMERICA_GUYANA
    AMERICA_HALIFAX
    AMERICA_INDIANA_INDIANAPOLIS
    AMERICA_JUNEAU
    AMERICA_LA_PAZ
    AMERICA_LIMA
    AMERICA_QUITO
    AMERICA_LOS_ANGELES
    AMERICA_MAZATLAN
    AMERICA_MEXICO_CITY
    AMERICA_GUADALAJARA
    AMERICA_MONTERREY
    AMERICA_MONTEVIDEO
    AMERICA_NEW_YORK
    AMERICA_PHOENIX
    AMERICA_PUERTO_RICO
    AMERICA_REGINA
    AMERICA_SANTIAGO
    AMERICA_SAO_PAULO
    AMERICA_ST_JOHNS
    AMERICA_TIJUANA
    ASIA_ALMATY
    ASIA_ASTANA
    ASIA_BAGHDAD
    ASIA_BAKU
    ASIA_BANGKOK
    ASIA_CHENNAI
    ASIA_HANOI
    ASIA_CHONGQING
    ASIA_COLOMBO
    ASIA_DHAKA
    ASIA_HONG_KONG
    ASIA_IRKUTSK
    ASIA_JAKARTA
    ASIA_JERUSALEM
    ASIA_KABUL
    ASIA_KAMCHATKA
    ASIA_KARACHI
    ASIA_ISLAMABAD
    ASIA_KATHMANDU
    ASIA_KOLKATA
    ASIA_MUMBAI
    ASIA_NEW_DELHI
    ASIA_KRASNOYARSK
    ASIA_KUALA_LUMPUR
    ASIA_KUWAIT
    ASIA_MAGADAN
    ASIA_MUSCAT
    ASIA_ABU_DHABI
    ASIA_NOVOSIBIRSK
    ASIA_RIYADH
    ASIA_SEOUL
    ASIA_SHANGHAI
    ASIA_SINGAPORE
    ASIA_SREDNEKOLYMSK
    ASIA_TAIPEI
    ASIA_TASHKENT
    ASIA_TBILISI
    ASIA_TEHRAN
    ASIA_TOKYO
    ASIA_OSAKA
    ASIA_SAPPORO
    ASIA_ULAANBAATAR
    ASIA_URUMQI
    ASIA_VLADIVOSTOK
    ASIA_YAKUTSK
    ASIA_YEKATERINBURG
    ASIA_YEREVAN
    ATLANTIC_AZORES
    ATLANTIC_CAPE_VERDE
    ATLANTIC_SOUTH_GEORGIA
    AUSTRALIA_ADELAIDE
    AUSTRALIA_BRISBANE
    AUSTRALIA_CANBERRA
    AUSTRALIA_DARWIN
    AUSTRALIA_HOBART
    AUSTRALIA_MELBOURNE
    AUSTRALIA_PERTH
    AUSTRALIA_SYDNEY
    ETC_GMT_PLUS_12
    ETC_UTC
    EUROPE_AMSTERDAM
    EUROPE_ATHENS
    EUROPE_BELGRADE
    EUROPE_BERN
    EUROPE_BERLIN
    EUROPE_BRATISLAVA
    EUROPE_BRUSSELS
    EUROPE_BUCHAREST
    EUROPE_BUDAPEST
    EUROPE_COPENHAGEN
    EUROPE_DUBLIN
    EUROPE_HELSINKI
    EUROPE_ISTANBUL
    EUROPE_KALININGRAD
    EUROPE_LISBON
    EUROPE_LJUBLJANA
    EUROPE_LONDON
    EUROPE_EDINBURGH
    EUROPE_MADRID
    EUROPE_MINSK
    EUROPE_MOSCOW
    EUROPE_ST_PETERSBURG
    EUROPE_PARIS
    EUROPE_PRAGUE
    EUROPE_RIGA
    EUROPE_ROME
    EUROPE_SAMARA
    EUROPE_SARAJEVO
    EUROPE_SKOPJE
    EUROPE_SOFIA
    EUROPE_STOCKHOLM
    EUROPE_TALLINN
    EUROPE_VIENNA
    EUROPE_VILNIUS
    EUROPE_VOLGOGRAD
    EUROPE_WARSAW
    EUROPE_ZAGREB
    EUROPE_ZURICH
    PACIFIC_APIA
    PACIFIC_AUCKLAND
    PACIFIC_WELLINGTON
    PACIFIC_CHATHAM
    PACIFIC_FAKAOFO
    PACIFIC_FIJI
    PACIFIC_GUADALCANAL
    PACIFIC_GUAM
    PACIFIC_HONOLULU
    PACIFIC_MAJURO
    PACIFIC_MIDWAY
    PACIFIC_NOUMEA
    PACIFIC_PAGO_PAGO
    PACIFIC_PORT_MORESBY
    PACIFIC_TONGATAPU
}

enum SnapshotFrequency {
    NONE
    DAILY
    WEEKLY
    MONTHLY
    QUARTERLY
    SEMIANNUAL
    ANNUAL
}

enum AssetType {
    STOCK
    BOND
    ETF
    MUTUAL_FUND
    CRYPTOCURRENCY
    REAL_ESTATE
    COLLECTIBLE
    PRIVATE_EQUITY
    VENTURE_CAPITAL
    PRIVATE_DEBT
    P2P_LENDING
    INSURANCE_POLICY
    AGRICULTURAL_LAND
    OTHER
}

enum FinancialAccountType {
    ONLINE_BANK
    BANK_ACCOUNT
    CIRCUIT
    DEPOSIT_BANK
    BROKER
    WALLET
    CASH
    CREDIT_CARD
    OTHER
}

enum TransactionAction {
    EXPENSES
    INCOME
    TRANSFER
}

enum TransactionStatus {
    APPROVED
    REJECTED
    IMPORT_PENDING
    IMPORT_REJECTED
    IMPORT_APPROVED
}

enum Currency {
    USD
    EUR
    GBP
    JPY
    CNY
    INR
    AUD
    CAD
    CHF
    SEK
    NZD
    MXN
    SGD
    HKD
    NOK
    KRW
    TRY
    UNKNOWN
}

enum RememberPeriod {
    SAME_DAY
    THREE_DAYS
    SEVEN_DAYS
    FOURTEEN_DAYS
    THIRTY_DAYS
    NINETY_DAYS
}

enum AppearanceMode {
    LOGO
    ICON
}

enum FileType {
    CSV
    PDF
}

enum Language {
    EN
    ES
    FR
    DE
    IT
    PT
    NL
    RU
    ZH
    JA
    KO
    AR
    HI
    TH
    VI
    TR
    PL
    CS
    HU
    RO
    BG
    HR
    SK
    SL
    ET
    LV
    LT
    MT
    FI
    SV
    DA
    NO
    IS
    EL
    HE
    FA
    UR
    BN
    TA
    TE
    ML
    KN
    GU
    MR
    PA
    OR
    AS
    NE
    SI
    MY
    KH
    LO
    KA
    AM
    TI
    SW
    ZU
    AF
    XH
    ST
    TN
    SS
    VE
    TS
    NR
    IG
    YO
    HA
    FF
    WO
    BM
    DY
    SN
}

enum DateFormat {
    DD_MM_YYYY
    MM_DD_YYYY
    YYYY_MM_DD
    DD_MM_YY
    MM_DD_YY
    YY_MM_DD
    DD_MMMM_YYYY
    MMMM_DD_YYYY
    YYYY_MMMM_DD
}

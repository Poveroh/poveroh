datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

generator client {
    provider = "prisma-client-js"
}

// ===========================================================================
// USER & AUTHENTICATION
// ===========================================================================
model User {
    id             String    @id @default(uuid())
    name           String
    surname        String
    email          String    @unique
    emailVerified  Boolean   @default(false)
    onBoardingStep Int       @default(1)
    onBoardingAt   DateTime?
    image          String?

    snapshotFrequency SnapshotFrequency @default(MONTHLY)
    baseCurrency      Currency          @default(EUR)

    // User Configuration Settings
    preferredCurrency Currency   @default(EUR)
    preferredLanguage Language   @default(EN)
    dateFormat        DateFormat @default(DD_MM_YYYY)
    country           Country    @default(UNITED_STATES)
    timezone          String     @default("UTC")

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    transactions      Transaction[]
    subscriptions     Subscription[]
    categories        Category[]
    financialAccounts FinancialAccount[]
    imports           Import[]
    sessions          Session[]
    accounts          Account[]
    verifications     Verification[]

    assets    Asset[]
    snapshots Snapshot[]

    @@index([surname])
    @@index([createdAt])
    @@index([email])
}

model Session {
    id        String   @id @default(uuid())
    token     String   @unique
    userId    String
    expiresAt DateTime
    ipAddress String?
    userAgent String?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([token])
}

model Account {
    id                    String    @id @default(uuid())
    accountId             String    @unique
    providerId            String
    userId                String
    accessToken           String?
    refreshToken          String?
    idToken               String?
    accessTokenExpiresAt  DateTime?
    refreshTokenExpiresAt DateTime?
    scope                 String?
    password              String?
    createdAt             DateTime  @default(now())
    updatedAt             DateTime  @updatedAt

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
}

model Verification {
    id         String   @id @default(uuid())
    identifier String
    value      String
    expiresAt  DateTime
    userId     String?
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([identifier, value])
    @@index([identifier])
    @@index([expiresAt])
    @@index([userId])
}

// ===========================================================================
// FINANCIAL ACCOUNTS
// ===========================================================================
model FinancialAccount {
    id          String               @id @default(uuid())
    userId      String
    title       String
    description String
    balance     Decimal              @default(0) @db.Decimal(20, 2)
    type        FinancialAccountType @default(BANK_ACCOUNT)
    logoIcon    String?
    createdAt   DateTime             @default(now())
    updatedAt   DateTime             @updatedAt

    subscriptions Subscription[]
    amounts       Amount[]
    user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
    imports       Import[]

    snapshotBalances SnapshotAccountBalance[]

    @@index([userId])
    @@map("FinancialAccounts")
}

// ===========================================================================
// ASSET SYSTEM
// ===========================================================================
model Asset {
    id          String    @id @default(uuid())
    userId      String
    title       String
    description String?
    type        AssetType
    currency    Currency  @default(EUR)
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    marketable  MarketableAsset?
    realEstate  RealEstateAsset?
    collectible CollectibleAsset?
    privateDeal PrivateDealAsset?
    insurance   InsuranceAsset?

    transactions   AssetTransaction[]
    snapshotValues SnapshotAssetValue[]

    @@index([userId])
    @@index([userId, type])
}

model MarketableAsset {
    id      String  @id @default(uuid())
    assetId String  @unique
    symbol  String?
    isin    String?

    asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)
}

model RealEstateAsset {
    id            String    @id @default(uuid())
    assetId       String    @unique
    address       String?
    purchasePrice Decimal?  @db.Decimal(20, 2)
    purchaseDate  DateTime?
    currentValue  Decimal?  @db.Decimal(20, 2)

    asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)
}

model CollectibleAsset {
    id              String    @id @default(uuid())
    assetId         String    @unique
    acquisitionCost Decimal?  @db.Decimal(20, 2)
    acquisitionDate DateTime?
    appraisalValue  Decimal?  @db.Decimal(20, 2)
    appraisalDate   DateTime?

    asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)
}

model PrivateDealAsset {
    id              String    @id @default(uuid())
    assetId         String    @unique
    committedAmount Decimal?  @db.Decimal(20, 2)
    calledAmount    Decimal?  @db.Decimal(20, 2)
    latestNav       Decimal?  @db.Decimal(20, 2)
    navDate         DateTime?

    asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)
}

model InsuranceAsset {
    id             String   @id @default(uuid())
    assetId        String   @unique
    policyNumber   String?
    premiumPaid    Decimal? @db.Decimal(20, 2)
    surrenderValue Decimal? @db.Decimal(20, 2)

    asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)
}

model AssetTransaction {
    id             String   @id @default(uuid())
    assetId        String
    date           DateTime
    quantityChange Decimal  @db.Decimal(20, 10)
    unitPrice      Decimal? @db.Decimal(20, 8)
    totalAmount    Decimal? @db.Decimal(20, 2)
    fees           Decimal? @db.Decimal(10, 2)
    note           String?

    asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

    @@index([assetId])
    @@index([assetId, date])
}

// ===========================================================================
// SNAPSHOT (historical wealth)
// ===========================================================================
model Snapshot {
    id           String   @id @default(uuid())
    userId       String
    snapshotDate DateTime @db.Timestamptz
    note         String?

    totalCash        Decimal @db.Decimal(20, 2)
    totalInvestments Decimal @db.Decimal(20, 2)
    totalNetWorth    Decimal @db.Decimal(20, 2)

    user            User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
    accountBalances SnapshotAccountBalance[]
    assetValues     SnapshotAssetValue[]

    @@unique([userId, snapshotDate])
    @@index([userId, snapshotDate(sort: Desc)])
}

model SnapshotAccountBalance {
    id         String  @id @default(uuid())
    snapshotId String
    accountId  String
    balance    Decimal @db.Decimal(20, 2)

    snapshot Snapshot         @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
    account  FinancialAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

    @@unique([snapshotId, accountId])
}

model SnapshotAssetValue {
    id         String   @id @default(uuid())
    snapshotId String
    assetId    String
    quantity   Decimal? @db.Decimal(20, 10)
    unitPrice  Decimal? @db.Decimal(20, 8)
    totalValue Decimal  @db.Decimal(20, 2)

    snapshot Snapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
    asset    Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

    @@unique([snapshotId, assetId])
}

// ===========================================================================
// IMPORT & TRANSACTIONS
// ===========================================================================
model Import {
    id                 String            @id @default(uuid())
    userId             String
    title              String
    financialAccountId String
    status             TransactionStatus @default(IMPORT_PENDING)
    createdAt          DateTime          @default(now())

    user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
    financialAccount FinancialAccount @relation(fields: [financialAccountId], references: [id], onDelete: Cascade)
    transactions     Transaction[]
    files            ImportFile[]

    @@index([userId])
    @@index([status])
}

model ImportFile {
    id        String   @id @default(uuid())
    importId  String
    filename  String
    filetype  FileType
    path      String
    createdAt DateTime @default(now())

    import Import @relation(fields: [importId], references: [id], onDelete: Cascade)

    @@index([importId])
}

model Transaction {
    id            String            @id @default(uuid())
    userId        String
    title         String
    date          DateTime
    icon          String?
    action        TransactionAction @default(EXPENSES)
    categoryId    String?
    subcategoryId String?
    importId      String?
    note          String?
    status        TransactionStatus @default(APPROVED)
    ignore        Boolean           @default(false)
    createdAt     DateTime          @default(now())

    user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
    category    Category?    @relation(fields: [categoryId], references: [id], onDelete: SetNull)
    subcategory Subcategory? @relation(fields: [subcategoryId], references: [id], onDelete: SetNull)
    import      Import?      @relation(fields: [importId], references: [id], onDelete: SetNull)

    media   TransactionMedia[]
    amounts Amount[]

    @@index([userId])
    @@index([categoryId])
    @@index([subcategoryId])
    @@index([date])
    @@index([userId, date])
}

model TransactionMedia {
    id            String   @id @default(uuid())
    transactionId String
    filename      String
    filetype      String
    path          String
    createdAt     DateTime @default(now())

    transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

    @@index([transactionId])
}

model Amount {
    id                 String            @id @default(uuid())
    transactionId      String
    amount             Float
    currency           Currency
    action             TransactionAction @default(EXPENSES)
    financialAccountId String
    createdAt          DateTime          @default(now())

    financialAccount FinancialAccount @relation(fields: [financialAccountId], references: [id], onDelete: Cascade)
    transaction      Transaction      @relation(fields: [transactionId], references: [id], onDelete: Cascade)

    @@index([transactionId])
    @@index([financialAccountId])
    @@index([action])
}

// ===========================================================================
// SUBSCRIPTIONS
// ===========================================================================
model Subscription {
    id                 String         @id @default(uuid())
    userId             String
    title              String
    description        String?
    amount             Float
    currency           Currency
    appearanceMode     AppearanceMode
    appearanceLogoIcon String
    firstPayment       DateTime
    cycleNumber        String
    cyclePeriod        String
    rememberPeriod     RememberPeriod
    financialAccountId String
    isEnabled          Boolean
    createdAt          DateTime       @default(now())

    user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
    financialAccount FinancialAccount @relation(fields: [financialAccountId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([financialAccountId])
    @@index([isEnabled])
}

// ===========================================================================
// CATEGORIES & SUBCATEGORIES
// ===========================================================================
model Category {
    id          String            @id @default(uuid())
    userId      String
    title       String
    description String?
    for         TransactionAction
    logoIcon    String
    createdAt   DateTime          @default(now())

    transactions  Transaction[]
    subcategories Subcategory[]
    user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([for])
}

model Subcategory {
    id          String   @id @default(uuid())
    categoryId  String
    title       String
    description String?
    logoIcon    String
    createdAt   DateTime @default(now())

    transactions Transaction[]
    category     Category      @relation(fields: [categoryId], references: [id], onDelete: Cascade)

    @@index([categoryId])
}

// ===========================================================================
// ENUMS
// ===========================================================================

enum SnapshotFrequency {
    NONE
    DAILY
    WEEKLY
    MONTHLY
    QUARTERLY
    SEMIANNUAL
    ANNUAL
}

enum AssetType {
    STOCK
    BOND
    ETF
    MUTUAL_FUND
    CRYPTOCURRENCY
    REAL_ESTATE
    COLLECTIBLE
    PRIVATE_EQUITY
    VENTURE_CAPITAL
    PRIVATE_DEBT
    P2P_LENDING
    INSURANCE_POLICY
    AGRICULTURAL_LAND
    OTHER
}

enum FinancialAccountType {
    ONLINE_BANK
    BANK_ACCOUNT
    CIRCUIT
    DEPOSIT_BANK
    BROKER
    WALLET
    CASH
    CREDIT_CARD
    OTHER
}

enum TransactionAction {
    TRANSFER
    EXPENSES
    INCOME
}

enum TransactionStatus {
    APPROVED
    REJECTED
    IMPORT_PENDING
    IMPORT_REJECTED
    IMPORT_APPROVED
}

enum Currency {
    USD
    EUR
    GBP
    JPY
    CNY
    INR
    AUD
    CAD
    CHF
    SEK
    NZD
    MXN
    SGD
    HKD
    NOK
    KRW
    TRY
    UNKNOWN
}

enum RememberPeriod {
    SAME_DAY
    THREE_DAYS
    SEVEN_DAYS
    FOURTEEN_DAYS
    THIRTY_DAYS
    NINETY_DAYS
}

enum AppearanceMode {
    LOGO
    ICON
}

enum FileType {
    CSV
    PDF
}

enum Language {
    EN
    ES
    FR
    DE
    IT
    PT
    NL
    RU
    ZH
    JA
    KO
    AR
    HI
    TH
    VI
    TR
    PL
    CS
    HU
    RO
    BG
    HR
    SK
    SL
    ET
    LV
    LT
    MT
    FI
    SV
    DA
    NO
    IS
    EL
    HE
    FA
    UR
    BN
    TA
    TE
    ML
    KN
    GU
    MR
    PA
    OR
    AS
    NE
    SI
    MY
    KH
    LO
    KA
    AM
    TI
    SW
    ZU
    AF
    XH
    ST
    TN
    SS
    VE
    TS
    NR
    IG
    YO
    HA
    FF
    WO
    BM
    DY
    SN
}

enum DateFormat {
    DD_MM_YYYY
    MM_DD_YYYY
    YYYY_MM_DD
    DD_MM_YY
    MM_DD_YY
    YY_MM_DD
    DD_MMMM_YYYY
    MMMM_DD_YYYY
    YYYY_MMMM_DD
}

enum Country {
    AFGHANISTAN
    ALBANIA
    ALGERIA
    ANDORRA
    ANGOLA
    ANTIGUA_AND_BARBUDA
    ARGENTINA
    ARMENIA
    AUSTRALIA
    AUSTRIA
    AZERBAIJAN
    BAHAMAS
    BAHRAIN
    BANGLADESH
    BARBADOS
    BELARUS
    BELGIUM
    BELIZE
    BENIN
    BHUTAN
    BOLIVIA
    BOSNIA_AND_HERZEGOVINA
    BOTSWANA
    BRAZIL
    BRUNEI
    BULGARIA
    BURKINA_FASO
    BURUNDI
    CABO_VERDE
    CAMBODIA
    CAMEROON
    CANADA
    CENTRAL_AFRICAN_REPUBLIC
    CHAD
    CHILE
    CHINA
    COLOMBIA
    COMOROS
    CONGO_DEMOCRATIC_REPUBLIC
    CONGO_REPUBLIC
    COSTA_RICA
    CROATIA
    CUBA
    CYPRUS
    CZECH_REPUBLIC
    DENMARK
    DJIBOUTI
    DOMINICA
    DOMINICAN_REPUBLIC
    ECUADOR
    EGYPT
    EL_SALVADOR
    EQUATORIAL_GUINEA
    ERITREA
    ESTONIA
    ESWATINI
    ETHIOPIA
    FIJI
    FINLAND
    FRANCE
    GABON
    GAMBIA
    GEORGIA
    GERMANY
    GHANA
    GREECE
    GRENADA
    GUATEMALA
    GUINEA
    GUINEA_BISSAU
    GUYANA
    HAITI
    HONDURAS
    HUNGARY
    ICELAND
    INDIA
    INDONESIA
    IRAN
    IRAQ
    IRELAND
    ISRAEL
    ITALY
    JAMAICA
    JAPAN
    JORDAN
    KAZAKHSTAN
    KENYA
    KIRIBATI
    KOREA_NORTH
    KOREA_SOUTH
    KUWAIT
    KYRGYZSTAN
    LAOS
    LATVIA
    LEBANON
    LESOTHO
    LIBERIA
    LIBYA
    LIECHTENSTEIN
    LITHUANIA
    LUXEMBOURG
    MADAGASCAR
    MALAWI
    MALAYSIA
    MALDIVES
    MALI
    MALTA
    MARSHALL_ISLANDS
    MAURITANIA
    MAURITIUS
    MEXICO
    MICRONESIA
    MOLDOVA
    MONACO
    MONGOLIA
    MONTENEGRO
    MOROCCO
    MOZAMBIQUE
    MYANMAR
    NAMIBIA
    NAURU
    NEPAL
    NETHERLANDS
    NEW_ZEALAND
    NICARAGUA
    NIGER
    NIGERIA
    NORTH_MACEDONIA
    NORWAY
    OMAN
    PAKISTAN
    PALAU
    PALESTINE
    PANAMA
    PAPUA_NEW_GUINEA
    PARAGUAY
    PERU
    PHILIPPINES
    POLAND
    PORTUGAL
    QATAR
    ROMANIA
    RUSSIA
    RWANDA
    SAINT_KITTS_AND_NEVIS
    SAINT_LUCIA
    SAINT_VINCENT_AND_GRENADINES
    SAMOA
    SAN_MARINO
    SAO_TOME_AND_PRINCIPE
    SAUDI_ARABIA
    SENEGAL
    SERBIA
    SEYCHELLES
    SIERRA_LEONE
    SINGAPORE
    SLOVAKIA
    SLOVENIA
    SOLOMON_ISLANDS
    SOMALIA
    SOUTH_AFRICA
    SOUTH_SUDAN
    SPAIN
    SRI_LANKA
    SUDAN
    SURINAME
    SWEDEN
    SWITZERLAND
    SYRIA
    TAIWAN
    TAJIKISTAN
    TANZANIA
    THAILAND
    TIMOR_LESTE
    TOGO
    TONGA
    TRINIDAD_AND_TOBAGO
    TUNISIA
    TURKEY
    TURKMENISTAN
    TUVALU
    UGANDA
    UKRAINE
    UNITED_ARAB_EMIRATES
    UNITED_KINGDOM
    UNITED_STATES
    URUGUAY
    UZBEKISTAN
    VANUATU
    VATICAN_CITY
    VENEZUELA
    VIETNAM
    YEMEN
    ZAMBIA
    ZIMBABWE
}

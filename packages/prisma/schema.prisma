// ---------- Base ----------
datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

generator client {
    provider = "prisma-client-js"
}

// ---------- User & App Domain ----------
model User {
    id            String   @id @default(uuid())
    name          String
    surname       String
    email         String   @unique
    password      String? // opzionale per social login
    emailVerified Boolean  @default(false)
    image         String?
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt

    // dominio app
    transactions  Transaction[]
    subscriptions Subscription[]
    categories    Category[]
    logins        UserLogin[]
    bankAccounts  BankAccount[]
    imports       Import[]

    // better-auth
    sessions      Session[]
    accounts      Account[] // Better-Auth accounts
    verifications Verification[]

    @@index([surname])
    @@index([createdAt])
    @@index([email])
}

model UserLogin {
    id        String   @id @default(uuid())
    device    String
    browser   String
    ip        String
    location  String
    createdAt DateTime @default(now())

    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId String

    @@index([userId])
    @@index([createdAt])
}

model BankAccount {
    id          String      @id @default(uuid())
    userId      String
    title       String
    description String
    type        AccountType @default(BANK_ACCOUNT)
    logoIcon    String?
    createdAt   DateTime    @default(now())

    subscriptions Subscription[]
    amounts       Amount[]
    user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
    imports       Import[]
    // Se stai rinominando la vecchia tabella "Account" dell'app, usa eventualmente:
    // @@map("bank_account")

    @@index([userId])
}

model Import {
    id        String            @id @default(uuid())
    userId    String
    title     String
    accountId String
    status    TransactionStatus @default(IMPORT_PENDING)
    createdAt DateTime          @default(now())

    user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)
    account BankAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

    transactions Transaction[]
    files        ImportFile[]

    @@index([userId])
    @@index([status])
}

model ImportFile {
    id        String   @id @default(uuid())
    importId  String
    filename  String
    filetype  FileType
    path      String
    createdAt DateTime @default(now())

    import Import @relation(fields: [importId], references: [id], onDelete: Cascade)

    @@index([importId])
}

model Transaction {
    id            String            @id @default(uuid())
    userId        String
    title         String
    date          DateTime
    icon          String?
    action        TransactionAction @default(EXPENSES)
    categoryId    String?
    subcategoryId String?
    importId      String?
    note          String?
    status        TransactionStatus @default(APPROVED)
    ignore        Boolean           @default(false)
    createdAt     DateTime          @default(now())

    user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
    category    Category?    @relation(fields: [categoryId], references: [id], onDelete: SetNull)
    subcategory Subcategory? @relation(fields: [subcategoryId], references: [id], onDelete: SetNull)
    import      Import?      @relation(fields: [importId], references: [id], onDelete: SetNull)

    media   TransactionMedia[]
    amounts Amount[]

    @@index([userId])
    @@index([categoryId])
    @@index([subcategoryId])
    @@index([date])
    @@index([userId, date])
}

model Subscription {
    id                 String         @id @default(uuid())
    userId             String
    title              String
    description        String?
    amount             Float
    currency           Currency
    appearanceMode     AppearanceMode
    appearanceLogoIcon String
    firstPayment       DateTime
    cycleNumber        String
    cyclePeriod        String
    rememberPeriod     RememberPeriod
    accountId          String
    isEnabled          Boolean
    createdAt          DateTime       @default(now())

    user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)
    account BankAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([accountId])
    @@index([isEnabled])
}

model TransactionMedia {
    id            String   @id @default(uuid())
    transactionId String
    filename      String
    filetype      String
    path          String
    createdAt     DateTime @default(now())

    transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

    @@index([transactionId])
}

model Category {
    id          String            @id @default(uuid())
    userId      String
    title       String
    description String?
    for         TransactionAction
    logoIcon    String
    createdAt   DateTime          @default(now())

    transactions  Transaction[]
    subcategories Subcategory[]

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([for])
}

model Subcategory {
    id          String   @id @default(uuid())
    categoryId  String
    title       String
    description String?
    logoIcon    String
    createdAt   DateTime @default(now())

    transactions Transaction[]

    category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

    @@index([categoryId])
}

model Amount {
    id            String            @id @default(uuid())
    transactionId String
    amount        Float
    currency      Currency
    action        TransactionAction @default(EXPENSES)
    accountId     String
    createdAt     DateTime          @default(now())

    account     BankAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
    transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

    @@index([transactionId])
    @@index([accountId])
    @@index([action])
}

// ---------- Better-Auth ----------
model Session {
    id        String   @id @default(uuid())
    token     String   @unique
    userId    String
    expiresAt DateTime
    ipAddress String?
    userAgent String?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    // @@map("session") // opzionale: mappa a un nome tabella custom

    @@index([userId])
    @@index([token])
}

model Account {
    // ATTENZIONE: questa è la tabella Better-Auth "Account"
    id                    String    @id @default(uuid())
    accountId             String    @unique
    providerId            String
    userId                String
    accessToken           String?
    refreshToken          String?
    idToken               String?
    accessTokenExpiresAt  DateTime?
    refreshTokenExpiresAt DateTime?
    scope                 String?
    password              String?
    createdAt             DateTime  @default(now())
    updatedAt             DateTime  @updatedAt

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    // NESSUNA @@map qui, così la tabella si chiama "Account" per Better-Auth

    @@index([userId])
}

model Verification {
    id         String   @id @default(uuid())
    identifier String // email o telefono
    value      String // codice/token
    expiresAt  DateTime
    userId     String?
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    user User? @relation(fields: [userId], references: [id], onDelete: Cascade)
    // @@map("verification") // opzionale

    @@unique([identifier, value])
    @@index([identifier])
    @@index([expiresAt])
    @@index([userId])
}

// ---------- Enum ----------
enum TransactionAction {
    TRANSFER
    EXPENSES
    INCOME
}

enum TransactionStatus {
    APPROVED
    REJECTED
    IMPORT_PENDING
    IMPORT_REJECTED
    IMPORT_APPROVED
}

enum AccountType {
    ONLINE_BANK
    BANK_ACCOUNT
    CIRCUIT
    DEPOSIT_BANK
    BROKER
}

enum Currency {
    USD
    EUR
    GBP
    JPY
    CNY
    INR
    AUD
    CAD
    CHF
    SEK
    NZD
    MXN
    SGD
    HKD
    NOK
    KRW
    TRY
    UNKNOWN
}

enum RememberPeriod {
    SAME_DAY
    THREE_DAYS
    SEVEN_DAYS
    FOURTEEN_DAYS
    THIRTY_DAYS
    NINETY_DAYS
}

enum AppearanceMode {
    LOGO
    ICON
}

enum FileType {
    CSV
    PDF
}

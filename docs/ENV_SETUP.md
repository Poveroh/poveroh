# Environment Variables

Environment variables are stored in files but are divided by application and deployment target.

## Environment Files Structure

The project uses a dual environment file system to support both development and production deployments:

- **`.env`**: Used for local development (DATABASE_HOST=localhost:5432)
- **`.env.production`**: Used for Docker/production deployments (DATABASE_HOST=db.poveroh.local:5432 or URL you need)
- **`.env.example`**: Template file with all available variables

### File Priority System

When running Docker deployment scripts (`npm run docker`), the system loads environment variables with the following priority:

1. **`.env.production`** (if exists) - Takes precedence for Docker deployments
2. **`.env`** (fallback) - Used if .env.production doesn't exist

### Automatic File Creation

For development and local deployment, either copy the `.env.example` file to `.env` manually or run `npm run setup:env`.
This will automatically create both files:

- **`.env`** with `DATABASE_HOST=localhost:5432` (for local development)
- **`.env.production`** with `DATABASE_HOST=db.poveroh.local:5432` (for Docker deployments)

The setup script will populate both files with default values. However, for improved application security, it is recommended to replace these defaults with your own custom values.

All applications retrieve the necessary variables from these files.

There are also `.env` files inside `packages/prisma`, `apps/app`, `apps/api` and `docker` folder that directly link to the `.env` file in project root. Do not touch them.

## Docker Deployment

When using Docker deployment via `npm run docker`, the system automatically:

1. **Checks for environment files** and creates them if missing
2. **Loads the appropriate environment file** with priority to `.env.production`
3. **Passes the environment file to Docker Compose** using the `--env-file` flag
4. **Ensures all containers receive the correct environment variables**

### Environment File Selection for Docker

- If `.env.production` exists → Uses `.env.production` (recommended for Docker deployments)
- If only `.env` exists → Falls back to `.env`
- If neither exists → Automatically creates both from `.env.example`

This ensures that Docker containers always receive the correct database host (`db:5432` instead of `localhost:5432`) and other production-specific configurations.

## Local hostnames and proxy

For local development we use a small nginx `proxy` service that routes traffic to the different internal services (app, api, cdn, studio). To make testing simple we recommend adding the following host entries to your machine's hosts file (the project contains a helper script that can add them for you):

```text
127.0.0.1 app.poveroh.local
127.0.0.1 api.poveroh.local
127.0.0.1 studio.poveroh.local
127.0.0.1 db.poveroh.local
127.0.0.1 redis.poveroh.local
127.0.0.1 cdn.poveroh.local
::1 app.poveroh.local
::1 api.poveroh.local
::1 studio.poveroh.local
::1 db.poveroh.local
::1 redis.poveroh.local
```

The repository exposes a small helper script `scripts/setup/proxy.js` which will attempt to append these lines to your `/etc/hosts` (on Unix) or the Windows hosts file using an elevated PowerShell command. The setup flow will then start the `proxy` container. You can run it with:

```bash
node scripts/setup/proxy.js
```

## CDN URL

If you use local file storage mode (`FILE_STORAGE_MODE=local`), the API generates static file URLs that point to a CDN storage host. For local development or local docker deployment the project expects the CDN to be available at `http://cdn.poveroh.local`. You can also configure the URL using an environment variable (if present) to use other storage mode:

```env
# optional override for the CDN base URL used by the API when FILE_STORAGE_MODE=local
CDN_URL=http://cdn.poveroh.local
```

## Database

```env
#Postgres connection, necessary for build and create the database in the first place. Edit the values below to match your database
POSTGRES_USER=poveroh
POSTGRES_PASSWORD=poveroh
POSTGRES_DB=poveroh
# For production deploy, enter url you need; otherwise if you are running locally use: db.poveroh.local:5432
DATABASE_HOST=db.poveroh.local:5432

#Database connection string for Prisma; don't change this
DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${DATABASE_HOST}/${POSTGRES_DB}
```

## Api

```env
#API port; default is 3001
API_PORT=3001

# JWT secret key for the API; change this to a random string
# If missing and you run project's setup script, it will generated by default
JWT_KEY=

# Enter the environment: development | production; leave blank for development
NODE_ENV=

# Base hostname for cookie scope and URL derivation
# For development, this can be left empty.
# For production, set to your base domain WITHOUT protocol and preferably apex domain (e.g., yourdomain.com).
# If you set an api on subdomains (app.yourdomain.com, api.yourdomain.com), using the apex here enables cross-subdomain cookies.
BASE_URL=http://localhost:3001

# Application base URL (frontend); used for cookie scope and URL derivation
APP_URL=http://localhost:3000

# Comma-separated list of allowed origins for CORS and auth trustedOrigins in production.
# Example: ALLOWED_ORIGINS=https://app.poveroh.com,https://admin.poveroh.com
ALLOWED_ORIGINS=http://localhost:3000,http://app.poveroh.local,http://admin.poveroh.local

# For production deploy, enter url you need; otherwise if you are running locally use: redis.poveroh.local:6379
REDIS_URL=redis.poveroh.local:6379

#Storage

# File storage mode; must be one of the following: local | aws | gcloud | azure | digitalocean
FILE_STORAGE_MODE=local

# For local storage, type full path of folder on your computer (es. /Users/<user>/data-folder)
# If missing and you run project's setup script, it will be set default folder (./cdn-data)
CDN_LOCAL_DATA_PATH=/Users/<user>/cdn-data

AWS_BUCKET=
AWS_REGION=
AWS_CREDENTIALS_ACCESSKEYID=
AWS_CREDENTIALS_SECRETACCESSKEY=

GCS_BUCKET=
GCS_PROJECTID=
GCS_FILEACCOUNT= # add as base64; get the account credentials json file content, convert to base64 and use it here

DIGITALOCEAN_BUCKET=
DIGITALOCEAN_REGION=
DIGITALOCEAN_ENDPOINT=
DIGITALOCEAN_CREDENTIALS_ACCESSKEYID=
DIGITALOCEAN_CREDENTIALS_SECRETACCESSKEY=

AZURE_CONNECTION_STRING=
AZURE_CONTAINER=
```

## App

```env
#API url;
# for development use localhost:3001;
# for local docker deployment use api.poveroh.local
# otherwise enter url you need
NEXT_PUBLIC_API_URL=http://api.poveroh.local:${API_PORT}
NEXT_PUBLIC_APP_VERSION=1.0.0

# Log level for the application; can be one of: DEBUG, INFO, WARN, ERROR, SILENT
LOG_LEVEL=info
```

## Docker

```env
# Set the base name for Docker containers created by Docker Compose
COMPOSE_PROJECT_NAME=poveroh
```
